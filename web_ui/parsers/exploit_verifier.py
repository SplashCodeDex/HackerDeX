import os
from typing import Optional
from models import VulnerabilityModel

class ExploitVerifier:
    """
    Uses Generative AI to generate safe verification scripts for detected vulnerabilities.
    """

    def __init__(self, gemini_client):
        self.client = gemini_client
        self.model = os.environ.get("GEMINI_MODEL", "gemini-2.0-flash")

    def generate_verification_script(self, vuln: VulnerabilityModel) -> str:
        """
        Generates a Python script to verify the specific vulnerability.
        """
        prompt = f"""
        You are an expert security researcher.
        VULNERABILITY: {vuln.title}
        SEVERITY: {vuln.severity}
        TARGET URL: {vuln.affected_url}
        DETAILS: {vuln.details}

        TASK: Write a standalone Python script using 'requests' to verify this specific vulnerability.

        REQUIREMENTS:
        1. The script must be SAFE (no destructive actions).
        2. It must print 'VULNERABLE' if the vulnerability is confirmed.
        3. It must print 'NOT VULNERABLE' if not.
        4. Return ONLY the python code block.
        """

        try:
            response = self.client.models.generate_content(
                model=self.model,
                contents=prompt
            )
            # Extract code block
            code = response.text
            if "```python" in code:
                code = code.split("```python")[1].split("```")[0].strip()
            elif "```" in code:
                 code = code.split("```")[1].split("```")[0].strip()
            return code
        except Exception as e:
            return f"# Error generating script: {str(e)}"
