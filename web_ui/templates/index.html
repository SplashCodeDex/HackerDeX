<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HackerDeX Security Lab</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0d1117;
            --sidebar: #161b22;
            --card: #21262d;
            --accent: #58a6ff;
            --accent-glow: rgba(88,166,255,0.3);
            --text: #c9d1d9;
            --border: #30363d;
            --success: #3fb950;
            --warning: #d29922;
            --error: #f85149;
        }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }

        /* SVG Icons */
        .icon { width: 16px; height: 16px; fill: currentColor; vertical-align: middle; }
        .icon-lg { width: 20px; height: 20px; }

        /* Sidebar */
        .sidebar { width: 260px; background: var(--sidebar); border-right: 1px solid var(--border); overflow-y: auto; display: flex; flex-direction: column; }
        .brand { padding: 20px; font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: 1.1rem; color: var(--accent); border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; }
        .category-list { list-style: none; padding: 0; margin: 0; }
        .category-item { padding: 12px 20px; cursor: pointer; border-left: 3px solid transparent; transition: 0.2s; font-size: 0.9rem; }
        .category-item:hover, .category-item.active { background: var(--card); border-left-color: var(--accent); color: white; }
        .tool-count { float: right; background: var(--border); padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; }

        /* Main Content */
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .header { padding: 25px 30px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .header-left h1 { margin: 0 0 5px 0; font-size: 1.5rem; }
        .header-left p { margin: 0; color: #8b949e; font-size: 0.9rem; }
        .header-right { display: flex; gap: 10px; }
        .header-btn { background: var(--card); border: 1px solid var(--border); color: var(--text); padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; gap: 8px; transition: 0.2s; }
        .header-btn:hover { border-color: var(--accent); color: white; }
        .header-btn.active { background: var(--accent); color: black; border-color: var(--accent); }

        .tools-panel { flex: 1; padding: 20px 30px; overflow-y: auto; }
        .tool-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; }

        /* Tool Card */
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 18px; transition: 0.2s; cursor: pointer; }
        .card:hover { transform: translateY(-2px); border-color: var(--accent); box-shadow: 0 4px 20px rgba(0,0,0,0.3), 0 0 0 1px var(--accent-glow); }
        .card h3 { margin: 0 0 8px 0; font-size: 0.95rem; color: white; }
        .card p { font-size: 0.8rem; color: #8b949e; margin: 0; line-clamp: 2; -webkit-line-clamp: 2; display: -webkit-box; -webkit-box-orient: vertical; overflow: hidden; }

        /* Console Modal */
        .console-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; backdrop-filter: blur(8px); z-index: 1000; }
        .console-modal { background: #0a0a0a; width: 80%; max-width: 900px; height: 70%; max-height: 600px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 25px 80px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.05); display: flex; flex-direction: column; overflow: hidden; }
        .console-header { display: flex; align-items: center; justify-content: space-between; padding: 15px 20px; background: linear-gradient(180deg, #1a1a1a 0%, #0f0f0f 100%); border-bottom: 1px solid var(--border); }
        .console-title { display: flex; align-items: center; gap: 12px; font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; font-weight: 600; }
        .console-dots { display: flex; gap: 8px; }
        .console-dot { width: 12px; height: 12px; border-radius: 50%; }
        .console-dot.red { background: #ff5f56; cursor: pointer; }
        .console-dot.red:hover { opacity: 0.8; }
        .console-dot.yellow { background: #ffbd2e; }
        .console-dot.green { background: #27c93f; }
        .console-status { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; color: #8b949e; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #555; }
        .status-dot.ready { background: var(--success); box-shadow: 0 0 8px var(--success); }
        .status-dot.running { background: var(--warning); animation: pulse 1s infinite; }
        .status-dot.error { background: var(--error); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Loading Spinner */
        .spinner { width: 20px; height: 20px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; display: inline-block; vertical-align: middle; margin-right: 8px; }
        .spinner-lg { width: 32px; height: 32px; border-width: 3px; }

        /* Skeleton Loader */
        .skeleton { background: linear-gradient(90deg, var(--card) 25%, #2a2f38 50%, var(--card) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 6px; }
        .skeleton-text { height: 14px; margin-bottom: 8px; }
        .skeleton-title { height: 20px; width: 60%; margin-bottom: 12px; }
        .skeleton-card { height: 80px; margin-bottom: 12px; }

        /* Empty State */
        .empty-state { text-align: center; padding: 60px 30px; color: #6e7681; }
        .empty-state .icon { width: 48px; height: 48px; opacity: 0.4; margin-bottom: 16px; }
        .empty-state h3 { margin: 0 0 8px 0; font-size: 1rem; color: #8b949e; }
        .empty-state p { margin: 0; font-size: 0.85rem; }

        /* Fade-in Animation for Cards */
        .card { animation: fadeIn 0.3s ease-out; }

        /* Toast Notifications */
        .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: var(--sidebar); border: 1px solid var(--border); padding: 12px 20px; border-radius: 8px; box-shadow: 0 8px 30px rgba(0,0,0,0.4); display: flex; align-items: center; gap: 10px; animation: fadeIn 0.3s ease-out; font-size: 0.85rem; }
        .toast.success { border-left: 3px solid var(--success); }
        .toast.error { border-left: 3px solid var(--error); }
        .toast.warning { border-left: 3px solid var(--warning); }

        .console-actions { display: flex; gap: 8px; }
        .console-btn { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #8b949e; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.75rem; transition: 0.2s; display: flex; align-items: center; gap: 6px; }
        .console-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .console-btn.ai-btn { background: linear-gradient(135deg, #4285f4 0%, #9b72cb 100%); color: white; border: none; }
        .console-btn.ai-btn:hover { opacity: 0.9; transform: scale(1.02); }

        .console-output { flex: 1; padding: 20px; overflow-y: auto; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; line-height: 1.7; white-space: pre-wrap; word-wrap: break-word; }
        .console-output .line { padding: 3px 0; }
        .console-output .timestamp { color: #444; margin-right: 12px; }
        .console-output .cmd { color: var(--accent); font-weight: 600; }
        .console-output .success { color: var(--success); }
        .console-output .warning { color: var(--warning); }
        .console-output .error { color: var(--error); }
        .console-output .info { color: #6e7681; }

        /* Agent Output Styles */
        .agent-line { padding: 2px 0; }
        .agent-line.thinking { color: #9b72cb; font-weight: 500; }
        .agent-line.decision { color: #ffe08a; }
        .agent-line.executing { color: #4285f4; font-weight: 600; }
        .agent-line.tool-output { color: #8b949e; font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; padding-left: 20px; border-left: 2px solid #333; margin-left: 8px; }
        .agent-line.divider { color: #444; font-style: italic; }

        /* Agent Chat Interface */
        .chat-container { display: flex; flex-direction: column; height: 350px; overflow-y: auto; padding: 15px; background: #0d1117; border: 1px solid #30363d; border-radius: 8px; margin-bottom: 20px; }
        .chat-bubble { padding: 10px 15px; border-radius: 12px; margin-bottom: 10px; font-size: 0.9rem; max-width: 85%; word-wrap: break-word; position: relative; animation: fadeIn 0.3s ease-out; }
        .chat-bubble.user { background: #1f6feb; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .chat-bubble.agent { background: #21262d; border: 1px solid #30363d; color: #c9d1d9; align-self: flex-start; border-bottom-left-radius: 2px; }
        .chat-timestamp { font-size: 0.7rem; color: #8b949e; margin-top: 4px; display: block; }
        .tool-output-block { background: #000; font-family: 'JetBrains Mono'; font-size: 0.8rem; padding: 10px; border-radius: 6px; margin-top: 5px; white-space: pre-wrap; color: #7ee787; border: 1px solid #333; overflow-x: auto; }

        .console-input { display: flex; align-items: center; padding: 12px 20px; background: #1a1a1a; border-top: 1px solid var(--border); }
        .console-input span { color: var(--accent); margin-right: 12px; font-family: 'JetBrains Mono', monospace; font-weight: 600; }
        .console-input input { flex: 1; background: transparent; border: none; color: white; font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; outline: none; }

        /* Intelligence Sidebar */
        .intel-sidebar { width: 350px; background: var(--sidebar); border-left: 1px solid var(--border); overflow-y: auto; display: none; flex-direction: column; }
        .intel-header { padding: 20px; border-bottom: 1px solid var(--border); background: #1a1a1a; display: flex; align-items: center; justify-content: space-between; }
        .intel-section { padding: 15px 20px; border-bottom: 1px solid var(--border); }
        .intel-section h4 { margin: 0 0 12px 0; font-size: 0.8rem; color: #8b949e; text-transform: uppercase; letter-spacing: 1px; }
        .target-item { background: var(--card); border: 1px solid var(--border); padding: 10px; border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: 0.2s; }
        .target-item:hover { border-color: var(--accent); }
        .target-item.active { border-color: var(--accent); background: rgba(88,166,255,0.05); }
        .target-item .host { font-weight: 600; font-size: 0.9rem; color: white; display: block; }
        .target-item .stats { font-size: 0.75rem; color: #6e7681; margin-top: 4px; }

        .profile-view { padding: 0; }
        .intel-pill { display: inline-flex; align-items: center; gap: 5px; background: #30363d; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; margin: 0 5px 5px 0; border: 1px solid transparent; }
        .intel-pill.vuln-high { border-color: var(--error); color: #ff7b72; }
        .intel-pill.vuln-med { border-color: var(--warning); color: #d29922; }
        .intel-pill.port { border-color: var(--success); color: #7ee787; }

        .empty-intel { text-align: center; padding: 40px 20px; color: #6e7681; font-size: 0.9rem; }

        /* Tool Config Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); z-index: 1001; }
        .modal { background: var(--sidebar); width: 480px; padding: 30px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
        .modal h2 { margin: 0 0 20px 0; color: white; font-size: 1.3rem; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.85rem; color: #8b949e; }
        .form-group input { width: 100%; padding: 12px; background: var(--bg); border: 1px solid var(--border); color: white; border-radius: 8px; font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; transition: 0.2s; }
        .form-group input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.2s; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: linear-gradient(135deg, var(--accent) 0%, #1f6feb 100%); color: white; }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px var(--accent-glow); }
        .btn-cancel { background: transparent; color: #8b949e; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; }

        /* Sessions Panel Styles */
        .session-card { background: var(--card); border: 1px solid var(--border); padding: 12px 15px; border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: 0.2s; }
        .session-card:hover { border-color: var(--accent); }
        .session-card.active { border-color: var(--success); box-shadow: 0 0 10px rgba(63, 185, 80, 0.2); }
        .session-card.pending { border-color: var(--warning); }
        .session-card.dead { border-color: var(--border); opacity: 0.6; }
        .session-card .session-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .session-card .session-type { font-size: 0.7rem; background: rgba(88,166,255,0.2); color: var(--accent); padding: 2px 8px; border-radius: 4px; text-transform: uppercase; }
        .session-card .session-status { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; }
        .session-card .session-status.active { background: rgba(63,185,80,0.2); color: var(--success); }
        .session-card .session-status.pending { background: rgba(210,153,34,0.2); color: var(--warning); }
        .session-card .session-status.dead { background: rgba(248,81,73,0.2); color: var(--error); }
        .session-card .session-target { font-weight: 600; color: white; font-size: 0.9rem; }
        .session-card .session-meta { font-size: 0.75rem; color: #6e7681; margin-top: 4px; }

        .listener-item { background: var(--card); border: 1px solid var(--border); padding: 10px 12px; border-radius: 6px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .listener-item .port { font-weight: 600; color: var(--success); }
        .listener-item .protocol { font-size: 0.75rem; color: #8b949e; }
        .listener-item .stop-btn { background: rgba(248,81,73,0.2); color: var(--error); border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.75rem; }

        .session-terminal { background: #000; font-family: 'JetBrains Mono'; font-size: 0.85rem; border-radius: 8px; padding: 15px; height: 200px; overflow-y: auto; white-space: pre-wrap; color: #7ee787; border: 1px solid #333; }
        .session-terminal-input { display: flex; margin-top: 10px; }
        .session-terminal-input input { flex: 1; background: #0a0a0a; border: 1px solid #333; border-radius: 4px; color: white; padding: 8px 12px; font-family: 'JetBrains Mono'; }
        .session-terminal-input button { background: var(--accent); border: none; color: black; padding: 8px 16px; border-radius: 4px; margin-left: 8px; cursor: pointer; }
    </style>
</head>
<body>

<!-- SVG Icon Definitions -->
<svg style="display: none;">
    <defs>
        <symbol id="icon-terminal" viewBox="0 0 24 24">
            <path d="M4 17l6-5-6-5m8 10h8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
        </symbol>
        <symbol id="icon-zap" viewBox="0 0 24 24">
            <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" fill="currentColor"/>
        </symbol>
        <symbol id="icon-trash" viewBox="0 0 24 24">
            <path d="M3 6h18M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2m3 0v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
        </symbol>
        <symbol id="icon-copy" viewBox="0 0 24 24">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2" stroke="currentColor" stroke-width="2" fill="none"/>
            <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
        </symbol>
        <symbol id="icon-brain" viewBox="0 0 24 24">
            <path d="M12 4.5a2.5 2.5 0 00-4.96-.46 2.5 2.5 0 00-1.98 3 2.5 2.5 0 00-1.32 4.24 3 3 0 00.34 5.58 2.5 2.5 0 002.96 3.08A2.5 2.5 0 0012 19.5a2.5 2.5 0 004.96.44 2.5 2.5 0 002.96-3.08 3 3 0 00.34-5.58 2.5 2.5 0 00-1.32-4.24 2.5 2.5 0 00-1.98-3A2.5 2.5 0 0012 4.5" stroke="currentColor" stroke-width="2" fill="none"/>
            <path d="M12 4.5v15M9 7l4.5 4.5L15 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
        </symbol>
        <symbol id="icon-rocket" viewBox="0 0 24 24">
            <path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 00-2.91-.09zM12 15l-3-3a22 22 0 012-3.95A12.88 12.88 0 0122 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 01-4 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
            <path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
        </symbol>
    </defs>
</svg>

<div class="sidebar">
    <div class="brand">
        <svg class="icon icon-lg"><use href="#icon-zap"/></svg>
        HackerDeX Lab
    </div>
    <ul class="category-list" id="categoryList"></ul>
</div>

<div class="main">
    <div class="header">
        <div class="header-left">
            <h1 id="pageTitle">Security Tools</h1>
            <p>Select a tool from any category to configure and launch a scan.</p>
            <div style="margin-top: 15px;">
                <input type="text" id="toolSearch" placeholder="üîç Search all tools..."
                       style="width: 300px; padding: 10px 15px; background: var(--sidebar); border: 1px solid var(--border); color: white; border-radius: 8px; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem;"
                       oninput="filterTools(this.value)">
            </div>
        </div>
        <div class="header-right">
            <button class="header-btn" onclick="toggleIntelPanel()">
                <svg class="icon"><use href="#icon-zap"/></svg>
                Intelligence Feed
            </button>
            <button class="header-btn" onclick="openSessionsModal()" style="border-color: var(--success); color: var(--success);">
                <svg class="icon"><use href="#icon-terminal"/></svg>
                Sessions <span id="sessionCount" style="background: var(--success); color: black; padding: 1px 6px; border-radius: 10px; font-size: 0.7rem; margin-left: 5px;">0</span>
            </button>
            <button class="header-btn ai-btn" onclick="openAgentModal()">
                <svg class="icon"><use href="#icon-brain"/></svg>
                Auto-Pilot
            </button>
            <button class="header-btn" onclick="generateReport()" style="border-color: var(--warning); color: var(--warning);">
                <svg class="icon"><use href="#icon-zap"/></svg>
                Gen Report
            </button>
        </div>
    </div>

    <div class="tools-panel">
        <div class="tool-grid" id="toolGrid"></div>
    </div>
</div>

<!-- Console Modal -->
<div class="console-overlay" id="consoleOverlay" onclick="closeConsoleOnBackdrop(event)">
    <div class="console-modal" onclick="event.stopPropagation()">
        <div class="console-header">
            <div class="console-title">
                <div class="console-dots">
                    <div class="console-dot red" onclick="toggleConsole()"></div>
                    <div class="console-dot yellow"></div>
                    <div class="console-dot green"></div>
                </div>
                <span>Terminal ‚Äî HackerDeX</span>
            </div>
            <div class="console-status">
                <div class="status-dot ready" id="statusDot"></div>
                <span id="statusText">Ready</span>
            </div>
            <div class="console-actions">
                <button class="console-btn" onclick="clearConsole()">
                    <svg class="icon"><use href="#icon-trash"/></svg>
                    Clear
                </button>
                <button class="console-btn" onclick="copyOutput()">
                    <svg class="icon"><use href="#icon-copy"/></svg>
                    Copy
                </button>
                <button class="console-btn ai-btn" onclick="analyzeWithGemini()">
                    <svg class="icon"><use href="#icon-brain"/></svg>
                    Analyze
                </button>
            </div>
        </div>
        <div class="console-output" id="consoleOutput"></div>
        <div class="console-input">
            <span>$</span>
            <input type="text" placeholder="Select a tool to run a scan..." disabled>
        </div>
    </div>
</div>

</div>

<!-- Agent Modal -->
<div class="modal-overlay" id="agentModal">
    <div class="modal" style="width: 600px;">
        <div class="console-header" style="margin: -30px -30px 20px -30px; padding: 20px; border-bottom: 1px solid #333; border-radius: 16px 16px 0 0;">
            <div class="console-title">
                <svg class="icon" style="color: #a5f3fc; margin-right: 10px;"><use href="#icon-brain"/></svg>
                <span>AI Auto-Pilot Agent</span>
            </div>
            <button class="console-btn" onclick="closeAgentModal()">Close</button>
        </div>

        <div class="form-group">
            <label>TARGET IP / URL</label>
            <input type="text" id="agentTarget" placeholder="e.g., localhost" value="localhost">
        </div>
        <div class="form-group">
            <label>OPERATIONAL GOAL</label>
            <textarea id="agentGoal" rows="3" style="width: 100%; background: var(--bg); border: 1px solid var(--border); color: white; padding: 12px; border-radius: 8px; font-family: 'JetBrains Mono';" placeholder="e.g., Scan for open ports and identify web vulnerabilities."></textarea>
        </div>

        <div id="agentChat" class="chat-container">
            <div class="chat-bubble agent">Agent initialized. Ready for orders.<span class="chat-timestamp">Now</span></div>
        </div>

        <div class="modal-actions">
            <button class="btn btn-primary" onclick="startAutoPilot()" style="width: 100%; justify-content: center; background: linear-gradient(135deg, #a5f3fc 0%, #4285f4 100%); color: black;">
                <svg class="icon"><use href="#icon-rocket"/></svg>
                Launch Auto-Pilot
            </button>
        </div>
    </div>
</div>

<!-- Report Modal -->
<div class="modal-overlay" id="reportModal">
    <div class="modal" style="width: 800px; max-height: 90vh; display: flex; flex-direction: column;">
        <div class="console-header" style="margin: -30px -30px 20px -30px; padding: 20px; border-bottom: 1px solid #333; border-radius: 16px 16px 0 0;">
            <div class="console-title">
                <svg class="icon" style="color: #d29922; margin-right: 10px;"><use href="#icon-zap"/></svg>
                <span>Engagement Report</span>
            </div>
            <button class="console-btn" onclick="closeReportModal()">Close</button>
        </div>
        <div id="reportContent" class="console-output" style="flex: 1; min-height: 400px; background: #0d1117; border: 1px solid #333; border-radius: 8px; padding: 20px; font-family: 'Inter', sans-serif;">
            <div class="spinner"></div> Generating Professional Report...
        </div>
        <div class="modal-actions">
            <button class="btn btn-primary" onclick="copyReport()" style="background: var(--warning); color: black;">
                <svg class="icon"><use href="#icon-copy"/></svg> Copy Markdown
            </button>
        </div>
    </div>
</div>

<!-- Exploit Modal -->
<div class="modal-overlay" id="exploitModal">
    <div class="modal" style="width: 700px; display: flex; flex-direction: column;">
        <div class="console-header" style="margin: -30px -30px 20px -30px; padding: 20px; border-bottom: 1px solid #333; border-radius: 16px 16px 0 0;">
            <div class="console-title">
                <svg class="icon" style="color: #f85149; margin-right: 10px;"><use href="#icon-zap"/></svg>
                <span>Generated Exploit PoC</span>
            </div>
            <button class="console-btn" onclick="closeExploitModal()">Close</button>
        </div>
        <div id="exploitCode" class="console-output" style="height: 300px; background: #0d1117; border: 1px solid #333; border-radius: 8px; padding: 15px; font-family: 'JetBrains Mono'; color: #7ee787;">
            <div class="spinner"></div> Generating Python PoC...
        </div>
        <div class="modal-actions">
            <button class="btn btn-primary" onclick="copyExploit()" style="background: var(--error); color: white;">
                <svg class="icon"><use href="#icon-copy"/></svg> Copy Code
            </button>
        </div>
    </div>
</div>

<!-- Sessions Modal -->
<div class="modal-overlay" id="sessionsModal">
    <div class="modal" style="width: 900px; height: 80vh; display: flex; flex-direction: column;">
        <div class="console-header" style="margin: -30px -30px 20px -30px; padding: 20px; border-bottom: 1px solid #333; border-radius: 16px 16px 0 0;">
            <div class="console-title">
                <svg class="icon" style="color: var(--success); margin-right: 10px;"><use href="#icon-terminal"/></svg>
                <span>C2 Sessions & Listeners</span>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="console-btn" onclick="refreshSessions()" style="color: var(--success);">‚Üª Refresh</button>
                <button class="console-btn" onclick="closeSessionsModal()">Close</button>
            </div>
        </div>

        <div style="display: flex; flex: 1; gap: 20px; overflow: hidden;">
            <!-- Left: Listeners + Session List -->
            <div style="width: 320px; display: flex; flex-direction: column; overflow: hidden;">
                <!-- Listeners Section -->
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0; color: var(--accent); font-size: 0.85rem;">üì° LISTENERS</h4>
                        <button class="console-btn" onclick="showNewListenerForm()" style="font-size: 0.7rem;">+ New</button>
                    </div>
                    <div id="newListenerForm" style="display: none; background: var(--card); padding: 10px; border-radius: 6px; margin-bottom: 10px;">
                        <input type="number" id="listenerPort" placeholder="Port (e.g. 4444)" style="width: 100%; padding: 8px; background: var(--bg); border: 1px solid var(--border); color: white; border-radius: 4px; margin-bottom: 8px;">
                        <div style="display: flex; gap: 8px;">
                            <button onclick="startNewListener()" style="flex: 1; background: var(--success); border: none; color: black; padding: 6px; border-radius: 4px; cursor: pointer;">Start TCP</button>
                            <button onclick="hideNewListenerForm()" style="background: var(--border); border: none; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer;">Cancel</button>
                        </div>
                    </div>
                    <div id="listenersList" style="max-height: 120px; overflow-y: auto;"></div>
                </div>

                <!-- Sessions List -->
                <div style="flex: 1; overflow-y: auto;">
                    <h4 style="margin: 0 0 10px 0; color: var(--accent); font-size: 0.85rem;">üîì SESSIONS</h4>
                    <div id="sessionsList"></div>
                </div>
            </div>

            <!-- Right: Session Details / Terminal -->
            <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                <div id="sessionDetails" style="flex: 1; display: flex; flex-direction: column;">
                    <div class="empty-intel" id="noSessionSelected">
                        <svg class="icon" style="width: 48px; height: 48px; opacity: 0.4;"><use href="#icon-terminal"/></svg>
                        <h3>No Session Selected</h3>
                        <p>Select a session from the list to view details and interact.</p>
                    </div>

                    <div id="activeSessionView" style="display: none; flex: 1; flex-direction: column;">
                        <div style="background: var(--card); padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <span id="detailType" class="session-type">SHELL</span>
                                    <span id="detailStatus" class="session-status active">ACTIVE</span>
                                </div>
                                <button onclick="deleteSelectedSession()" style="background: rgba(248,81,73,0.2); color: var(--error); border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">‚ò† Kill</button>
                            </div>
                            <div style="margin-top: 10px; font-size: 0.85rem;">
                                <div><strong>Target:</strong> <span id="detailTarget">-</span></div>
                                <div><strong>Source:</strong> <span id="detailSource">-</span></div>
                                <div><strong>Credentials:</strong> <span id="detailCreds">-</span></div>
                            </div>
                        </div>

                        <h4 style="margin: 0 0 10px 0; color: var(--accent); font-size: 0.85rem;">üíª INTERACTIVE TERMINAL</h4>
                        <div id="sessionTerminal" class="session-terminal">$ Awaiting connection...</div>
                        <div class="session-terminal-input">
                            <input type="text" id="terminalInput" placeholder="Enter command..." onkeypress="if(event.key==='Enter') sendSessionCmd()">
                            <button onclick="sendSessionCmd()">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Session Summary Footer -->
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; font-size: 0.8rem; color: #8b949e;">
            <span>Total: <strong id="summaryTotal">0</strong> | Active: <strong id="summaryActive" style="color: var(--success);">0</strong> | Pending: <strong id="summaryPending" style="color: var(--warning);">0</strong></span>
            <span>Listeners: <strong id="summaryListeners">0</strong></span>
        </div>
    </div>
</div>

<!-- Tool Config Modal -->
<div class="modal-overlay" id="configModal">
    <div class="modal">
        <h2 id="modalToolName">Tool Name</h2>
        <div class="form-group">
            <label>TARGET URL / IP</label>
            <input type="text" id="targetInput" placeholder="http://host.docker.internal:5000">
        </div>
        <div id="contextSuggestions" style="margin-bottom: 20px;"></div>
        <div class="modal-actions">
            <button class="btn btn-cancel" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="startScan()">
                <svg class="icon"><use href="#icon-rocket"/></svg>
                Launch Scan
            </button>
        </div>
    </div>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
    let currentTools = {};
    let selectedTool = null;
    let consoleOpen = false;

    const socket = io();
    const consoleOutput = document.getElementById('consoleOutput');

    function log(text, type = 'info') {
        const time = new Date().toLocaleTimeString('en-US', { hour12: false });
        const line = document.createElement('div');
        line.className = 'line';
        line.innerHTML = `<span class="timestamp">[${time}]</span><span class="${type}">${escapeHtml(text)}</span>`;
        consoleOutput.appendChild(line);
        consoleOutput.scrollTop = consoleOutput.scrollHeight;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function setStatus(status) {
        const dot = document.getElementById('statusDot');
        const text = document.getElementById('statusText');
        dot.className = 'status-dot ' + status;
        text.innerText = status.charAt(0).toUpperCase() + status.slice(1);
    }

    function toggleConsole() {
        consoleOpen = !consoleOpen;
        document.getElementById('consoleOverlay').style.display = consoleOpen ? 'flex' : 'none';
        document.getElementById('toggleConsoleBtn').classList.toggle('active', consoleOpen);
    }

    function closeConsoleOnBackdrop(e) {
        if (e.target === document.getElementById('consoleOverlay')) {
            toggleConsole();
        }
    }

    function clearConsole() {
        consoleOutput.innerHTML = '';
        log('Console cleared', 'info');
    }

    function copyOutput() {
        const text = consoleOutput.innerText;
        navigator.clipboard.writeText(text).then(() => {
            log('Output copied to clipboard!', 'success');
        });
    }

    // Socket events
    socket.on('connect', () => {
        log('WebSocket connected', 'success');
        setStatus('ready');
    });

    socket.on('scan_output', (data) => {
        const line = data.line.trim();
        let type = 'info';
        if (line.toLowerCase().includes('error') || line.toLowerCase().includes('failed')) type = 'error';
        else if (line.toLowerCase().includes('warning') || line.toLowerCase().includes('warn')) type = 'warning';
        else if (line.toLowerCase().includes('success') || line.toLowerCase().includes('found') || line.toLowerCase().includes('open')) type = 'success';

        log(data.line.replace(/\n$/, ''), type);
    });

    socket.on('scan_complete', (data) => {
        log(`Scan complete (exit: ${data.exit_code})`, data.exit_code === 0 ? 'success' : 'warning');
        setStatus('ready');

        // Fetch output for analysis
        safeFetch(`/api/status/${data.job_id}`)
            .then(job => {
                lastScanOutput = job.output || '';
                lastScanTool = job.tool || '';
                lastScanTarget = job.target || '';
            })
            .catch(() => {}); // Silently fail for status fetch
    });

    socket.on('scan_error', (data) => {
        log(`Error: ${data.error}`, 'error');
        setStatus('error');
    });

    // Load tools
    safeFetch('/api/tools')
        .then(catalog => {
            currentTools = catalog;
            const categories = Object.keys(catalog);
            const list = document.getElementById('categoryList');

            categories.forEach((cat, index) => {
                const li = document.createElement('li');
                li.className = 'category-item';
                li.innerHTML = `${cat} <span class="tool-count">${catalog[cat].length}</span>`;
                li.onclick = () => loadCategory(cat, li);
                list.appendChild(li);
                if (index === 0) loadCategory(cat, li);
            });

            log(`Loaded ${Object.values(catalog).flat().length} tools in ${categories.length} categories`, 'success');
        });

    function loadCategory(name, element) {
        document.querySelectorAll('.category-item').forEach(el => el.classList.remove('active'));
        if(element) element.classList.add('active');

        document.getElementById('pageTitle').innerText = name;
        const grid = document.getElementById('toolGrid');
        grid.innerHTML = '';

        const tools = currentTools[name] || [];
        tools.forEach(tool => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `<h3>${tool}</h3><p>Click to configure and launch.</p>`;
            card.onclick = () => openModal(tool);
            grid.appendChild(card);
        });
    }

    function filterTools(query) {
        const grid = document.getElementById('toolGrid');
        grid.innerHTML = '';

        if (!query || query.length < 2) {
            // Reset to first category if search is cleared
            const firstCat = Object.keys(currentTools)[0];
            if (firstCat) loadCategory(firstCat);
            return;
        }

        document.getElementById('pageTitle').innerText = `Search: "${query}"`;
        document.querySelectorAll('.category-item').forEach(el => el.classList.remove('active'));

        const lowerQuery = query.toLowerCase();
        let matchCount = 0;

        Object.entries(currentTools).forEach(([category, tools]) => {
            tools.forEach(tool => {
                if (tool.toLowerCase().includes(lowerQuery) || category.toLowerCase().includes(lowerQuery)) {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `<h3>${tool}</h3><p><small style="color: #8b949e;">${category}</small></p>`;
                    card.onclick = () => openModal(tool);
                    grid.appendChild(card);
                    matchCount++;
                }
            });
        });

        if (matchCount === 0) {
            grid.innerHTML = '<p style="color: #666; padding: 20px;">No tools found matching your search.</p>';
        }
    }

    function openModal(toolName) {
        selectedTool = toolName;
        document.getElementById('modalToolName').innerText = toolName;
        document.getElementById('configModal').style.display = 'flex';

        // Context Suggestion logic
        const target = document.getElementById('targetInput').value;
        const suggestionDiv = document.getElementById('contextSuggestions');
        if (target && suggestionDiv) {
            suggestionDiv.innerHTML = '<div class="spinner"></div> Checking Intel...';
            safeFetch(`/api/targets/${target}/profile`)
                .then(profile => {
                    if (profile) {
                        let html = '<div style="background: rgba(88,166,255,0.1); padding: 10px; border-radius: 8px; font-size: 0.8rem; border: 1px dashed var(--accent);">';
                        html += `üí° <b>Intel Found:</b> ${profile.ports.length} ports, ${profile.vulnerabilities.length} vulns.<br>`;
                        if (profile.technologies.length > 0) {
                            html += `üõ†Ô∏è <b>Tech:</b> ${profile.technologies.slice(0, 3).map(t => t.name).join(', ')}`;
                        }
                        html += '</div>';
                        suggestionDiv.innerHTML = html;
                    } else {
                        suggestionDiv.innerHTML = '';
                    }
                })
                .catch(() => suggestionDiv.innerHTML = '');
        }
    }

    function closeModal() {
        document.getElementById('configModal').style.display = 'none';
        selectedTool = null;
        if(document.getElementById('contextSuggestions')) document.getElementById('contextSuggestions').innerHTML = '';
    }

    function startScan() {
        const target = document.getElementById('targetInput').value;
        if (!target) return alert("Please enter a target!");

        closeModal();

        if (!consoleOpen) toggleConsole();

        log(`Launching ${selectedTool} against ${target}...`, 'cmd');
        setStatus('running');

        safeFetch('/api/scan', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ tool: selectedTool, target: target })
        })
        .then(data => {
            if (data.error) {
                log(`Error: ${data.message}`, 'error');
                setStatus('error');
                return;
            }
            log(`Job started: ${data.job_id}`, 'info');
        })
        .catch(() => setStatus('error'));
    }

    // Initial messages
    log('HackerDeX Security Lab v1.0', 'cmd');
    log('Ready to scan. Select a tool to begin.', 'info');

    // Check Gemini status
    safeFetch('/api/gemini-status')
        .then(data => {
            if (data.configured) {
                log(`Gemini ${data.model} ready for analysis`, 'success');
            } else {
                log('Gemini API not configured (set GEMINI_API_KEY)', 'warning');
            }
        });

    // Store last scan info for analysis
    let lastScanOutput = '';
    let lastScanTool = '';
    let lastScanTarget = '';

    function analyzeWithGemini() {
        if (!lastScanOutput) {
            log('No scan output to analyze. Run a scan first!', 'warning');
            return;
        }

        log('Sending output to Gemini 2.5 Pro for analysis...', 'cmd');
        setStatus('running');

        safeFetch('/api/analyze', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                output: lastScanOutput,
                tool: lastScanTool,
                target: lastScanTarget
            })
        })
        .then(data => {
            if (data.error) {
                log(`Analysis Error: ${data.error}`, 'error');
                setStatus('error');
                return;
            }

            log('=== GEMINI ANALYSIS ===', 'cmd');
            const lines = data.analysis.split('\n');
            lines.forEach(line => {
                if (line.startsWith('##') || line.startsWith('**')) {
                    log(line, 'cmd');
                } else if (line.toLowerCase().includes('high') || line.toLowerCase().includes('critical')) {
                    log(line, 'error');
                } else if (line.toLowerCase().includes('medium') || line.toLowerCase().includes('warning')) {
                    log(line, 'warning');
                } else if (line.includes('‚úì') || line.toLowerCase().includes('low')) {
                    log(line, 'success');
                } else {
                    log(line, 'info');
                }
            });
            log('=== END ANALYSIS ===', 'cmd');
            setStatus('ready');
        })
        .catch(err => {
            log(`Network error: ${err}`, 'error');
            setStatus('error');
        });
    }

    // Agent Functions
    function openAgentModal() {
        document.getElementById('agentModal').style.display = 'flex';
    }

    function closeAgentModal() {
        document.getElementById('agentModal').style.display = 'none';
    }

    // Agent WebSocket Listeners
    socket.on('agent_update', (data) => {
        const chatDiv = document.getElementById('agentChat');
        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        let content = data.message;

        if (data.type === 'tool_output') {
             content = `<div class="tool-output-block">${content}</div>`;
        } else if (content.includes('üß†')) {
             content = `<span style="color: #9b72cb;">${content}</span>`;
        } else if (content.includes('üí°')) {
             content = `<span style="color: #ffe08a;">${content}</span>`;
        } else if (content.includes('‚ö°')) {
             content = `<span style="color: #4285f4; font-weight: 600;">${content}</span>`;
        } else if (content.includes('‚úÖ')) {
             content = `<span style="color: var(--success); font-weight: 600;">${content}</span>`;
        } else if (content.includes('‚ùå') || content.includes('‚ö†Ô∏è')) {
             content = `<span style="color: var(--error); font-weight: 600;">${content}</span>`;
        }

        const bubble = document.createElement('div');
        bubble.className = 'chat-bubble agent';
        bubble.innerHTML = `${content}<span class="chat-timestamp">${time}</span>`;

        chatDiv.appendChild(bubble);
        chatDiv.scrollTop = chatDiv.scrollHeight;
    });

    function startAutoPilot() {
        const target = document.getElementById('agentTarget').value;
        const goal = document.getElementById('agentGoal').value;

        if (!target || !goal) {
            alert('Please provide both target and goal!');
            return;
        }

        const chatDiv = document.getElementById('agentChat');
        chatDiv.innerHTML = '<div class="info" style="text-align: center; color: #666; margin-bottom: 20px;">--- New Mission Started ---</div>';

        const userBubble = document.createElement('div');
        userBubble.className = 'chat-bubble user';
        userBubble.innerHTML = `<b>Target:</b> ${target}<br><b>Goal:</b> ${goal}<span class="chat-timestamp">Now</span>`;
        chatDiv.appendChild(userBubble);

        safeFetch('/api/autopilot', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ target: target, goal: goal })
        })
        .then(data => {
            if (data.error) {
                const errBubble = document.createElement('div');
                errBubble.className = 'chat-bubble agent';
                errBubble.innerHTML = `<span style="color: var(--error);">Error: ${data.error}</span><span class="chat-timestamp">Now</span>`;
                chatDiv.appendChild(errBubble);
            } else {
                const okBubble = document.createElement('div');
                okBubble.className = 'chat-bubble agent';
                okBubble.innerHTML = `Mission started and goal locked. Reasoning engine engaged.<span class="chat-timestamp">Now</span>`;
                chatDiv.appendChild(okBubble);
            }
        })
        .catch(() => {
            const errBubble = document.createElement('div');
            errBubble.className = 'chat-bubble agent';
            errBubble.innerHTML = `<span style="color: var(--error);">Failed to connect to agent backend.</span><span class="chat-timestamp">Now</span>`;
            chatDiv.appendChild(errBubble);
        });
    }

    // Intelligence Sidebar Logic
    let intelOpen = false;

    function toggleIntelPanel() {
        const panel = document.getElementById('intelSidebar');
        intelOpen = !intelOpen;
        panel.style.display = intelOpen ? 'flex' : 'none';
        if (intelOpen) loadTargets();
    }

    function loadTargets() {
        const list = document.getElementById('targetList');
        list.innerHTML = '<div class="spinner"></div> Loading...';

        safeFetch('/api/targets')
            .then(targets => {
                if (targets.length === 0) {
                    list.innerHTML = '<div class="empty-intel">No targets discovered yet.</div>';
                    return;
                }
                list.innerHTML = targets.map(t => `
                    <div class="target-item" onclick="viewProfile('${t.id}')">
                        <span class="host">${t.target}</span>
                        <div class="stats">
                            üõ°Ô∏è ${t.vulns_count} Vulns | üîå ${t.ports_count} Ports | üïí ${new Date(t.last_seen).toLocaleTimeString()}
                        </div>
                    </div>
                `).join('');
            })
            .catch(() => list.innerHTML = '<div class="empty-intel">Failed to load targets</div>');
    }

    function viewProfile(tid) {
        document.getElementById('targetListSection').style.display = 'none';
        document.getElementById('profileSection').style.display = 'block';
        document.getElementById('profileContent').innerHTML = '<div class="spinner"></div> Loading profile...';

        safeFetch(`/api/targets/${tid}/profile`)
            .then(t => {
                document.getElementById('profileHost').innerText = t.main_target;
                document.getElementById('profileId').innerText = t.id;

                let html = `
                    <div class="intel-section">
                        <h4>Ports & Services</h4>
                        <div>${t.ports.length ? t.ports.map(p => `
                            <div class="intel-pill port">
                                <b>${p.port}/${p.protocol}</b> ${p.service} ${p.version ? `(${p.version})` : ''}
                            </div>
                        `).join('') : '<small>None found</small>'}</div>
                    </div>
                    <div class="intel-section">
                        <h4>Vulnerabilities</h4>
                        <div>${t.vulnerabilities.length ? t.vulnerabilities.map(v => `
                            <div class="intel-pill vuln-${v.severity == 'critical' || v.severity == 'high' ? 'high' : 'med'}" style="display: flex; justify-content: space-between; align-items: center;">
                                <span title="${v.details}"><b>${v.severity.toUpperCase()}</b>: ${v.title}</span>
                                <button onclick="generateExploit('${v.title.replace(/'/g, "\\'")}', '${t.main_target}')" style="background: transparent; border: none; cursor: pointer; color: inherit; padding: 0 4px;" title="Generate AI Exploit">‚ö°</button>
                            </div>
                        `).join('') : '<small>No vulnerabilities detected</small>'}</div>
                    </div>
                    <div class="intel-section">
                        <h4>Technologies</h4>
                        <div>${t.technologies.length ? t.technologies.map(tech => `
                            <div class="intel-pill">
                                üõ†Ô∏è ${tech.name} ${tech.version ? `(${tech.version})` : ''}
                            </div>
                        `).join('') : '<small>Unknown</small>'}</div>
                    </div>
                    <div class="intel-section">
                        <h4>History</h4>
                        <small style="color: #6e7681;">Discovered URLs: ${t.urls.length}</small>
                    </div>
                `;
                document.getElementById('profileContent').innerHTML = html;
            })
            .catch(() => document.getElementById('profileContent').innerHTML = '<div class="empty-intel">Failed to load profile</div>');
    }

    // Exploit Generation
    function generateExploit(vulnTitle, target) {
        document.getElementById('exploitModal').style.display = 'flex';
        const codeBlock = document.getElementById('exploitCode');
        codeBlock.innerText = 'Generating exploit code...';

        showToast(`Generating exploit for: ${vulnTitle}`, 'info');

        safeFetch('/api/generate_exploit', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ vuln: vulnTitle, target: target })
        })
        .then(data => {
            if (data.status === 'success') {
                codeBlock.innerText = data.code;
                showToast('Exploit generated successfully!', 'success');
            } else {
                codeBlock.innerText = `Error: ${data.error}`;
                showToast('Failed to generate exploit', 'error');
            }
        })
        .catch(err => {
            codeBlock.innerText = `Network Error: ${err.message}`;
        });
    }

    function closeExploitModal() {
        document.getElementById('exploitModal').style.display = 'none';
    }

    function copyExploit() {
        const text = document.getElementById('exploitCode').innerText;
        navigator.clipboard.writeText(text).then(() => {
            showToast('Exploit code copied!', 'success');
        });
    }

    function backToTargets() {
        document.getElementById('targetListSection').style.display = 'flex';
        document.getElementById('profileSection').style.display = 'none';
        loadTargets();
    }

    // WebSocket refresh on store update
    socket.on('store_updated', (data) => {
        if (intelOpen) {
            loadTargets();
            // If viewing this target, refresh profile
            const currentProfileId = document.getElementById('profileId').innerText;
            if (currentProfileId === data.target_id) viewProfile(data.target_id);
        }
        showToast(`Intel gathered: ${data.message}`, 'success');
    });

    // Toast Notification System
    function showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `<span class="spinner" style="display: none;"></span>${message}`;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    }

    // Global error handler for fetch
    function safeFetch(url, options = {}) {
        return fetch(url, options)
            .then(r => {
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                return r.json();
            })
            .catch(err => {
                showToast(`Network Error: ${err.message}`, 'error');
                throw err;
            });
    }

    // Connection error handling
    socket.on('connect_error', () => {
        showToast('Lost connection to server!', 'error');
        setStatus('error');
    });

    socket.on('reconnect', () => {
        showToast('Reconnected to server', 'success');
        setStatus('ready');
    });

    // Report Generation Functions
    function generateReport() {
        document.getElementById('reportModal').style.display = 'flex';
        const contentDiv = document.getElementById('reportContent');
        contentDiv.innerHTML = '<div class="spinner"></div> Generating Professional Report...';

        safeFetch('/api/generate_report', { method: 'POST' })
            .then(data => {
                if (data.status === 'success') {
                    contentDiv.innerText = data.report; // Display raw markdown for now
                    showToast('Report generated successfully!', 'success');
                } else {
                    contentDiv.innerHTML = `<div class="error">Failed to generate report: ${data.error}</div>`;
                }
            })
            .catch(err => {
                contentDiv.innerHTML = `<div class="error">Network Error: ${err.message}</div>`;
            });
    }

    function closeReportModal() {
        document.getElementById('reportModal').style.display = 'none';
    }

    function copyReport() {
        const text = document.getElementById('reportContent').innerText;
        navigator.clipboard.writeText(text).then(() => {
            showToast('Report copied to clipboard!', 'success');
        });
    }

    // ==================== SESSIONS PANEL FUNCTIONS ====================
    let selectedSessionId = null;
    let sessionPollInterval = null;

    function openSessionsModal() {
        document.getElementById('sessionsModal').style.display = 'flex';
        refreshSessions();
        // Start polling for updates
        sessionPollInterval = setInterval(refreshSessions, 5000);
    }

    function closeSessionsModal() {
        document.getElementById('sessionsModal').style.display = 'none';
        if (sessionPollInterval) {
            clearInterval(sessionPollInterval);
            sessionPollInterval = null;
        }
    }

    function refreshSessions() {
        // Fetch sessions
        safeFetch('/api/sessions')
            .then(data => {
                renderSessionsList(data.sessions || []);
                renderSummary(data.summary || {});
                document.getElementById('sessionCount').textContent = data.summary?.active || 0;
            })
            .catch(err => console.error('Failed to fetch sessions:', err));

        // Fetch listeners
        safeFetch('/api/listeners')
            .then(data => {
                renderListenersList(data.listeners || []);
                document.getElementById('summaryListeners').textContent = data.listeners?.length || 0;
            })
            .catch(err => console.error('Failed to fetch listeners:', err));
    }

    function renderSessionsList(sessions) {
        const container = document.getElementById('sessionsList');
        if (sessions.length === 0) {
            container.innerHTML = '<div class="empty-intel" style="padding: 20px;"><p>No sessions yet. Run scans or start a listener.</p></div>';
            return;
        }

        container.innerHTML = sessions.map(s => `
            <div class="session-card ${s.status}" onclick="selectSession('${s.session_id}')">
                <div class="session-header">
                    <span class="session-type">${s.session_type}</span>
                    <span class="session-status ${s.status}">${s.status.toUpperCase()}</span>
                </div>
                <div class="session-target">${s.target_ip}${s.target_port ? ':' + s.target_port : ''}</div>
                <div class="session-meta">
                    ${s.source_tool} | ${s.username ? s.username + '@' : ''}${new Date(s.created_at).toLocaleTimeString()}
                </div>
            </div>
        `).join('');
    }

    function renderListenersList(listeners) {
        const container = document.getElementById('listenersList');
        if (listeners.length === 0) {
            container.innerHTML = '<div style="color: #6e7681; font-size: 0.8rem; text-align: center; padding: 10px;">No active listeners</div>';
            return;
        }

        container.innerHTML = listeners.map(l => `
            <div class="listener-item">
                <div>
                    <span class="port">:${l.port}</span>
                    <span class="protocol">${l.protocol.toUpperCase()}</span>
                    <span style="font-size: 0.7rem; color: #6e7681; margin-left: 8px;">${l.connections || 0} conn</span>
                </div>
                <button class="stop-btn" onclick="stopListener(${l.port})">Stop</button>
            </div>
        `).join('');
    }

    function renderSummary(summary) {
        document.getElementById('summaryTotal').textContent = summary.total_sessions || 0;
        document.getElementById('summaryActive').textContent = summary.active || 0;
        document.getElementById('summaryPending').textContent = summary.pending || 0;
    }

    function showNewListenerForm() {
        document.getElementById('newListenerForm').style.display = 'block';
        document.getElementById('listenerPort').focus();
    }

    function hideNewListenerForm() {
        document.getElementById('newListenerForm').style.display = 'none';
        document.getElementById('listenerPort').value = '';
    }

    function startNewListener() {
        const port = document.getElementById('listenerPort').value;
        if (!port) {
            showToast('Please enter a port number', 'warning');
            return;
        }

        safeFetch('/api/listeners', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ port: parseInt(port), protocol: 'tcp' })
        })
        .then(data => {
            if (data.status === 'started') {
                showToast(`Listener started on port ${port}`, 'success');
                hideNewListenerForm();
                refreshSessions();
            } else {
                showToast(data.error || 'Failed to start listener', 'error');
            }
        })
        .catch(err => showToast('Network error', 'error'));
    }

    function stopListener(port) {
        safeFetch(`/api/listeners/${port}`, { method: 'DELETE' })
            .then(data => {
                if (data.status === 'stopped') {
                    showToast(`Listener on port ${port} stopped`, 'success');
                    refreshSessions();
                } else {
                    showToast(data.error || 'Failed to stop listener', 'error');
                }
            })
            .catch(err => showToast('Network error', 'error'));
    }

    function selectSession(sessionId) {
        selectedSessionId = sessionId;

        safeFetch(`/api/sessions/${sessionId}`)
            .then(session => {
                document.getElementById('noSessionSelected').style.display = 'none';
                document.getElementById('activeSessionView').style.display = 'flex';

                document.getElementById('detailType').textContent = session.session_type;
                document.getElementById('detailStatus').textContent = session.status.toUpperCase();
                document.getElementById('detailStatus').className = `session-status ${session.status}`;
                document.getElementById('detailTarget').textContent = `${session.target_ip}:${session.target_port || '-'}`;
                document.getElementById('detailSource').textContent = session.source_tool;
                document.getElementById('detailCreds').textContent = session.username
                    ? `${session.username}:${session.password || '***'}`
                    : (session.cookie ? '[Cookie captured]' : '-');

                document.getElementById('sessionTerminal').textContent = `$ Connected to ${session.target_ip}\n`;

                // Fetch any buffered output
                pollSessionOutput();
            })
            .catch(err => showToast('Failed to load session', 'error'));
    }

    function deleteSelectedSession() {
        if (!selectedSessionId) return;

        if (confirm('Are you sure you want to kill this session?')) {
            safeFetch(`/api/sessions/${selectedSessionId}`, { method: 'DELETE' })
                .then(data => {
                    showToast('Session terminated', 'success');
                    selectedSessionId = null;
                    document.getElementById('noSessionSelected').style.display = 'block';
                    document.getElementById('activeSessionView').style.display = 'none';
                    refreshSessions();
                })
                .catch(err => showToast('Failed to delete session', 'error'));
        }
    }

    function sendSessionCmd() {
        if (!selectedSessionId) return;

        const input = document.getElementById('terminalInput');
        const command = input.value.trim();
        if (!command) return;

        const terminal = document.getElementById('sessionTerminal');
        terminal.textContent += `$ ${command}\n`;
        input.value = '';

        safeFetch(`/api/sessions/${selectedSessionId}/command`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ command })
        })
        .then(data => {
            if (data.status !== 'sent') {
                terminal.textContent += `[!] ${data.error}\n`;
            }
            // Poll for output after sending
            setTimeout(pollSessionOutput, 500);
        })
        .catch(err => {
            terminal.textContent += `[!] Network error\n`;
        });

        terminal.scrollTop = terminal.scrollHeight;
    }

    function pollSessionOutput() {
        if (!selectedSessionId) return;

        safeFetch(`/api/sessions/${selectedSessionId}/output`)
            .then(data => {
                if (data.output) {
                    const terminal = document.getElementById('sessionTerminal');
                    terminal.textContent += data.output;
                    terminal.scrollTop = terminal.scrollHeight;
                }
            })
            .catch(() => {});
    }

    // Listen for new session detection
    socket.on('session_detected', (data) => {
        showToast(`${data.count} new session(s) from ${data.tool}!`, 'success');
        document.getElementById('sessionCount').textContent =
            parseInt(document.getElementById('sessionCount').textContent) + data.count;
    });

    // Listen for new connections on listeners
    socket.on('new_connection', (data) => {
        showToast(`New connection from ${data.client_ip} on port ${data.listener_port}!`, 'success');
        refreshSessions();
    });
</script>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

</body>
</html>
